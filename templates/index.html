<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mahdiyyah She fest ‚Äì Result Kiosk</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root {
      --bg-cream-1: #fff7f0;
      --bg-cream-2: #f8f0e8;
      --bg-cream-3: #f2e6dd;

      --c-orange: #ff8a00;
      --c-pink: #ff3366;
      --c-gold: #f5c453;
      --c-teal: #37e6d8;
      --c-dark: #111827;
      --c-muted: #6b7280;

      --radius-pill: 999px;
      --easing-soft: cubic-bezier(0.33, 0, 0.15, 1);
      --easing-spring: cubic-bezier(0.23, 1, 0.32, 1);
      --easing-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      outline: none !important;
    }

    html, body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: radial-gradient(circle at top,
                                  var(--bg-cream-1) 0%,
                                  var(--bg-cream-2) 45%,
                                  var(--bg-cream-3) 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--c-dark);
      cursor: none;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    body::-webkit-scrollbar { display: none; }

    /* ===== BASE WALL (LEADERBOARD / CANDIDATE IFRAME) ===== */

    #mainFrame {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      border: none;
      background: radial-gradient(circle at top,
                                  #fff7f0 0%,
                                  #f5f0eb 45%,
                                  #ede7e1 100%);
      pointer-events: none;
      -ms-overflow-style: none;
      scrollbar-width: none;
      transition: filter 600ms ease-out;
    }
    #mainFrame::-webkit-scrollbar { display: none; }

    /* ===== FREE-FLOATING BUTTERFLIES (BACKGROUND) ===== */

    .butterfly-field {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }

    .butterfly-free {
      position: absolute;
      width: 85px;
      height: auto;
      opacity: 0.35;
      transform-origin: center;
      will-change: transform;
      transition: filter 0.4s ease-out;

      background: radial-gradient(
        ellipse at center,
        rgba(255, 138, 0, 0.12) 0%,
        rgba(255, 51, 102, 0.08) 40%,
        rgba(55, 230, 216, 0.06) 70%,
        transparent 100%
      );
      padding: 20px;
      border-radius: 50%;

      filter: 
        drop-shadow(0 8px 16px rgba(255, 138, 0, 0.25))
        drop-shadow(0 4px 12px rgba(255, 51, 102, 0.2))
        drop-shadow(0 12px 24px rgba(55, 230, 216, 0.15))
        drop-shadow(0 2px 8px rgba(15, 23, 42, 0.3));

      animation: butterfly-ambient-glow 4s ease-in-out infinite;
    }

    @keyframes butterfly-ambient-glow {
      0%, 100% {
        filter: 
          drop-shadow(0 8px 16px rgba(255, 138, 0, 0.25))
          drop-shadow(0 4px 12px rgba(255, 51, 102, 0.2))
          drop-shadow(0 12px 24px rgba(55, 230, 216, 0.15))
          drop-shadow(0 2px 8px rgba(15, 23, 42, 0.3));
      }
      50% {
        filter: 
          drop-shadow(0 12px 20px rgba(255, 138, 0, 0.35))
          drop-shadow(0 6px 16px rgba(255, 51, 102, 0.3))
          drop-shadow(0 16px 32px rgba(55, 230, 216, 0.25))
          drop-shadow(0 4px 12px rgba(15, 23, 42, 0.4));
      }
    }

    /* ===== PROCESS SHELL (OVERLAY BOX) ===== */

    .process-shell {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      pointer-events: none;

      opacity: 0;
      transform: translateY(24px) scale(0.94);
      transition:
        opacity 420ms var(--easing-spring),
        transform 420ms var(--easing-spring);
    }
    .process-shell.shell-active {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .process-card {
      position: relative;
      width: 520px;
      height: 320px;
      border-radius: 42px;
      background: radial-gradient(circle at top left,
                                  #ffffff 0%,
                                  #fff7f0 55%,
                                  #f4e4d7 100%);
      box-shadow: 0 30px 70px rgba(15,23,42,0.35);
      overflow: hidden;
      transform-origin: center;
      transform: translateY(10px) scale(0.96);
      opacity: 0;
      transition:
        opacity 480ms var(--easing-spring),
        transform 480ms var(--easing-spring),
        box-shadow 480ms var(--easing-soft);
    }
    .process-card.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
      box-shadow: 0 38px 80px rgba(15,23,42,0.45);
    }

    .process-border {
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 2px;
      background: linear-gradient(135deg,
                                  var(--c-orange),
                                  var(--c-pink),
                                  var(--c-teal));
      -webkit-mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.5;
      pointer-events: none;
      transition:
        opacity 400ms var(--easing-soft),
        background 400ms var(--easing-soft);
    }
    .border-muted   { opacity: 0.35 !important; }
    .border-active  { 
      opacity: 0.85 !important;
      animation: border-glow 2s ease-in-out infinite;
    }
    .border-checking {
      opacity: 0.90 !important;
      background: linear-gradient(135deg,
                                  var(--c-orange),
                                  var(--c-gold),
                                  var(--c-orange));
      background-size: 200% 200%;
      animation: border-shimmer 2s linear infinite;
    }
    .border-analyzing {
      opacity: 0.95 !important;
      background: linear-gradient(135deg,
                                  var(--c-teal),
                                  var(--c-pink),
                                  var(--c-teal));
      background-size: 200% 200%;
      animation: border-shimmer 1.5s linear infinite;
    }
    .border-success { 
      opacity: 0.95 !important;
      background: linear-gradient(135deg, #22c55e, #4ade80, #a7f3d0);
      animation: border-success-glow 2s ease-in-out infinite;
    }
    .border-error {
      opacity: 1 !important;
      background: linear-gradient(135deg, #ef4444, #f97316, #ef4444);
      background-size: 200% 200%;
      animation: border-error-pulse 1s ease-in-out infinite;
    }

    @keyframes border-glow {
      0%, 100% { opacity: 0.85; }
      50%      { opacity: 0.95; }
    }

    @keyframes border-shimmer {
      0%   { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    @keyframes border-success-glow {
      0%, 100% { opacity: 0.95; filter: brightness(1); }
      50%      { opacity: 1; filter: brightness(1.1); }
    }

    @keyframes border-error-pulse {
      0%, 100% { opacity: 1; background-position: 0% 50%; }
      50%      { opacity: 0.95; background-position: 100% 50%; }
    }

    .process-inner {
      position: absolute;
      inset: 18px 20px;
      border-radius: 32px;
      background: radial-gradient(circle at top,
                                  #fff7f0 0%,
                                  #fbf1e7 40%,
                                  #f3e3d8 100%);
      overflow: hidden;
    }

    /* ===== VFX INSIDE PROCESS CARD ===== */

    .process-vfx {
      position: absolute;
      inset: -25%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
      transition: opacity 600ms ease-out;
    }

    .process-vfx-gradient {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0% 0%, rgba(255,138,0,0.50), transparent 70%),
        radial-gradient(circle at 100% 100%, rgba(255,51,102,0.45), transparent 70%),
        radial-gradient(circle at 100% 0%, rgba(55,230,216,0.38), transparent 70%);
      opacity: 0.7;
      filter: blur(36px);
      animation: bg-rotate 32s linear infinite;
    }

    .process-vfx-lines {
      position: absolute;
      inset: 8%;
      background-image:
        radial-gradient(circle at 40% 10%, rgba(148,163,184,0.35) 0, transparent 55%),
        radial-gradient(circle at 60% 90%, rgba(156,163,175,0.28) 0, transparent 55%);
      mix-blend-mode: soft-light;
      opacity: 0.55;
    }

    .process-vfx-orbit {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .process-vfx-orbit-ring {
      width: 120%;
      height: 120%;
      border-radius: 50%;
      border: 1px solid rgba(17,24,39,0.12);
      box-shadow: 0 12px 40px rgba(15,23,42,0.25);
      backdrop-filter: blur(12px);
      position: relative;
      animation: orbit-spin 40s linear infinite;
      opacity: 0.55;
    }
    .process-vfx-orbit-ring::before,
    .process-vfx-orbit-ring::after {
      content: "";
      position: absolute;
      inset: 10%;
      border-radius: inherit;
      border: 1px dashed rgba(148,163,184,0.35);
      animation: orbit-spin 50s linear infinite;
    }
    .process-vfx-orbit-ring::after {
      inset: 22%;
      opacity: 0.7;
      animation-duration: 64s;
    }

    .process-card.state-checking .process-vfx-gradient {
      animation-duration: 20s;
      opacity: 0.85;
    }

    .process-card.state-analyzing .process-vfx-gradient {
      animation-duration: 12s;
      opacity: 0.95;
      filter: blur(28px);
    }

    .process-card.state-building .process-vfx {
      opacity: 0.6;
    }

    .process-card.state-result .process-vfx {
      opacity: 0.8;
    }

    .process-card.state-error .process-vfx-gradient {
      background:
        radial-gradient(circle at 0% 0%, rgba(239,68,68,0.55), transparent 70%),
        radial-gradient(circle at 100% 100%, rgba(249,115,22,0.50), transparent 70%),
        radial-gradient(circle at 50% 50%, rgba(239,68,68,0.45), transparent 70%);
      animation-duration: 8s;
      opacity: 0.9;
    }

    @keyframes bg-rotate {
      0%   { transform: translate3d(0,0,0) rotate(0deg); }
      25%  { transform: translate3d(-4%,2%,0) rotate(8deg); }
      50%  { transform: translate3d(2%,-4%,0) rotate(16deg); }
      75%  { transform: translate3d(4%,3%,0) rotate(24deg); }
      100% { transform: translate3d(0,0,0) rotate(32deg); }
    }

    @keyframes orbit-spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .scene-strip {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      perspective: 1000px;
      z-index: 1;
    }

    /* ===== BUTTERFLY IN PROCESS-CARD ===== */

    .butterfly-container {
      position: absolute;
      top: 18%;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 2;
    }

    .butterfly-img {
      width: 100%;
      height: auto;
      transform-origin: 40% 60%;
      filter: drop-shadow(0 10px 18px rgba(15,23,42,0.4));
      animation:
        butterfly-float 7s ease-in-out infinite,
        butterfly-glow 5s ease-in-out infinite;
    }

    @keyframes butterfly-float {
      0%,100% { transform: translate3d(0,0,0) rotate(-4deg) scale(1); }
      50%     { transform: translate3d(0,-8px,0) rotate(2deg) scale(1.02); }
    }

    @keyframes butterfly-glow {
      0%,100% { filter: drop-shadow(0 10px 18px rgba(15,23,42,0.4)); opacity: 0.95; }
      50%     { filter: drop-shadow(0 14px 26px rgba(255,51,102,0.5)); opacity: 1; }
    }

    .process-card.state-inserted .butterfly-img {
      animation:
        butterfly-float 5s ease-in-out infinite,
        butterfly-glow 4s ease-in-out infinite;
    }

    .process-card.state-checking .butterfly-img {
      animation:
        butterfly-checking 2.5s ease-in-out infinite,
        butterfly-glow-intense 2s ease-in-out infinite;
      transform-origin: 35% 65%;
    }

    .process-card.state-analyzing .butterfly-img {
      animation:
        butterfly-analyzing 1.8s ease-in-out infinite,
        butterfly-glow-pulse 1.5s ease-in-out infinite;
    }

    .process-card.state-building .butterfly-img {
      animation:
        butterfly-float 6s ease-in-out infinite,
        butterfly-glow 4.8s ease-in-out infinite;
      opacity: 0.9;
    }

    .process-card.state-result .butterfly-img {
      animation:
        butterfly-celebrate 3s ease-in-out infinite,
        butterfly-glow-success 2.5s ease-in-out infinite;
    }

    .process-card.state-error .butterfly-img {
      animation:
        butterfly-shake 0.5s ease-in-out infinite,
        butterfly-glow-error 1s ease-in-out infinite;
    }

    @keyframes butterfly-checking {
      0%,100% { transform: translate3d(-6px,0,0) rotate(-8deg) scale(1); }
      50%     { transform: translate3d(6px,-10px,0) rotate(8deg) scale(1.05); }
    }

    @keyframes butterfly-analyzing {
      0%,100% { transform: translate3d(0,0,0) rotate(-2deg) scale(1) rotateY(0deg); }
      25%     { transform: translate3d(-4px,-6px,0) rotate(-6deg) scale(1.03) rotateY(-10deg); }
      75%     { transform: translate3d(4px,-6px,0) rotate(6deg) scale(1.03) rotateY(10deg); }
    }

    @keyframes butterfly-celebrate {
      0%,100% { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
      25%     { transform: translate3d(-8px,-12px,0) rotate(-12deg) scale(1.08); }
      75%     { transform: translate3d(8px,-12px,0) rotate(12deg) scale(1.08); }
    }

    @keyframes butterfly-shake {
      0%, 100% { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
      25%      { transform: translate3d(-4px,0,0) rotate(-3deg) scale(0.98); }
      75%      { transform: translate3d(4px,0,0) rotate(3deg) scale(0.98); }
    }

    @keyframes butterfly-glow-intense {
      0%,100% { filter: drop-shadow(0 12px 20px rgba(255,138,0,0.5)); opacity: 0.98; }
      50%     { filter: drop-shadow(0 16px 30px rgba(245,196,83,0.7)); opacity: 1; }
    }

    @keyframes butterfly-glow-pulse {
      0%,100% { filter: drop-shadow(0 14px 24px rgba(55,230,216,0.6)); opacity: 1; }
      50%     { filter: drop-shadow(0 18px 34px rgba(255,51,102,0.7)); opacity: 1; }
    }

    @keyframes butterfly-glow-success {
      0%,100% { filter: drop-shadow(0 16px 28px rgba(34,197,94,0.6)); opacity: 1; }
      50%     { filter: drop-shadow(0 20px 38px rgba(74,222,128,0.8)); opacity: 1; }
    }

    @keyframes butterfly-glow-error {
      0%,100% { filter: drop-shadow(0 14px 24px rgba(239,68,68,0.7)); opacity: 1; }
      50%     { filter: drop-shadow(0 18px 32px rgba(249,115,22,0.8)); opacity: 1; }
    }

    /* ===== STATUS CHIP ===== */

    .status-chip {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.4rem 1.1rem;
      border-radius: var(--radius-pill);
      background: rgba(17,24,39,0.86);
      color: #f9fafb;
      font-size: 0.78rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.45rem;
      z-index: 3;
      transition: all 300ms var(--easing-soft);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34,197,94,0.25);
      animation: status-pulse 1.8s ease-out infinite;
      transition: background 300ms ease, box-shadow 300ms ease;
    }

    .process-card.state-inserted .status-dot {
      background: #3b82f6;
      box-shadow: 0 0 0 6px rgba(59,130,246,0.25);
    }

    .process-card.state-checking .status-dot {
      background: var(--c-orange);
      box-shadow: 0 0 0 6px rgba(255,138,0,0.25);
      animation: status-pulse-fast 1.2s ease-out infinite;
    }

    .process-card.state-analyzing .status-dot {
      background: var(--c-teal);
      box-shadow: 0 0 0 6px rgba(55,230,216,0.25);
      animation: status-pulse-faster 0.8s ease-out infinite;
    }

    .process-card.state-result .status-dot {
      background: #22c55e;
      box-shadow: 0 0 0 8px rgba(34,197,94,0.35);
      animation: status-pulse-success 1.5s ease-out infinite;
    }

    .process-card.state-error .status-dot {
      background: #ef4444;
      box-shadow: 0 0 0 8px rgba(239,68,68,0.35);
      animation: status-pulse-error 0.6s ease-out infinite;
    }

    @keyframes status-pulse {
      0%,100% { transform: scale(0.9); opacity: 0.8; }
      50%     { transform: scale(1.04); opacity: 1; }
    }

    @keyframes status-pulse-fast {
      0%,100% { transform: scale(0.85); opacity: 0.75; }
      50%     { transform: scale(1.1); opacity: 1; }
    }

    @keyframes status-pulse-faster {
      0%,100% { transform: scale(0.8); opacity: 0.7; }
      50%     { transform: scale(1.15); opacity: 1; }
    }

    @keyframes status-pulse-success {
      0%,100% { transform: scale(0.95); opacity: 0.9; }
      50%     { transform: scale(1.08); opacity: 1; }
    }

    @keyframes status-pulse-error {
      0%,100% { transform: scale(0.9); opacity: 0.85; }
      50%     { transform: scale(1.12); opacity: 1; }
    }

    /* ===== STATE VISUALS ===== */

    .card-visual {
      width: 260px;
      height: 160px;
      border-radius: 24px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      box-shadow: 0 20px 40px rgba(59,130,246,0.45);
      transform: rotateX(18deg) rotateZ(-10deg);
      transform-origin: center;
      position: relative;
      color: #fff;
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      padding: 18px 20px;
      font-weight: 600;
      letter-spacing: 0.12em;
      font-size: 0.9rem;
      animation: card-breathe 4.6s ease-in-out infinite;
    }
    .card-visual::before {
      content: "";
      position: absolute;
      inset: 12px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.85);
      opacity: 0.85;
    }
    .card-visual::after {
      content: "";
      position: absolute;
      top: 16px;
      right: 20px;
      width: 50px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
    }

    @keyframes card-breathe {
      0%,100% { transform: rotateX(18deg) rotateZ(-10deg) translateY(0); }
      50%     { transform: rotateX(21deg) rotateZ(-6deg) translateY(-6px); }
    }

    .checking-visual {
      width: 280px;
      height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .checking-scanner {
      width: 240px;
      height: 100px;
      border-radius: 20px;
      background: linear-gradient(135deg, #1f2937, #374151);
      box-shadow: 0 20px 40px rgba(15,23,42,0.5);
      position: relative;
      overflow: hidden;
      transform: rotateX(15deg);
      border: 2px solid rgba(255,138,0,0.3);
    }

    .checking-grid {
      position: absolute;
      inset: 15px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }

    .checking-grid span {
      background: linear-gradient(to top, var(--c-orange), var(--c-gold));
      border-radius: 2px;
      opacity: 0.3;
      animation: checking-bars 2s ease-in-out infinite;
    }

    .checking-grid span:nth-child(1) { animation-delay: 0s; }
    .checking-grid span:nth-child(2) { animation-delay: 0.1s; }
    .checking-grid span:nth-child(3) { animation-delay: 0.2s; }
    .checking-grid span:nth-child(4) { animation-delay: 0.3s; }
    .checking-grid span:nth-child(5) { animation-delay: 0.4s; }
    .checking-grid span:nth-child(6) { animation-delay: 0.5s; }
    .checking-grid span:nth-child(7) { animation-delay: 0.6s; }
    .checking-grid span:nth-child(8) { animation-delay: 0.7s; }

    @keyframes checking-bars {
      0%, 100% { opacity: 0.3; transform: scaleY(0.5); }
      50%      { opacity: 1; transform: scaleY(1); }
    }

    .checking-beam {
      position: absolute;
      inset: 0;
      background: linear-gradient(to right,
                                  transparent,
                                  rgba(255,138,0,0.4),
                                  transparent);
      animation: checking-beam-sweep 2s linear infinite;
    }

    @keyframes checking-beam-sweep {
      0%   { transform: translateX(-100%); opacity: 0; }
      10%  { opacity: 1; }
      90%  { opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }

    .checking-label {
      font-size: 0.8rem;
      color: var(--c-muted);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      animation: checking-label-pulse 1.5s ease-in-out infinite;
    }

    @keyframes checking-label-pulse {
      0%, 100% { opacity: 0.7; }
      50%      { opacity: 1; }
    }

    .analyzing-visual {
      width: 280px;
      height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
    }

    .analyzing-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: conic-gradient(from 0deg,
                                  var(--c-teal),
                                  var(--c-pink),
                                  var(--c-orange),
                                  var(--c-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 20px 40px rgba(55,230,216,0.4);
      animation: analyzing-spin 2s linear infinite;
      position: relative;
    }

    .analyzing-circle::before {
      content: "";
      position: absolute;
      inset: 8px;
      border-radius: 50%;
      background: radial-gradient(circle,
                                  #fff7f0 0%,
                                  #fbf1e7 100%);
    }

    .analyzing-circle::after {
      content: "";
      position: absolute;
      inset: 20px;
      border-radius: 50%;
      border: 3px dashed rgba(55,230,216,0.6);
      animation: analyzing-inner-spin 3s linear infinite reverse;
    }

    @keyframes analyzing-spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes analyzing-inner-spin {
      0%   { transform: rotate(0deg) scale(1); opacity: 0.8; }
      50%  { transform: rotate(180deg) scale(1.05); opacity: 1; }
      100% { transform: rotate(360deg) scale(1); opacity: 0.8; }
    }

    .analyzing-dots {
      display: flex;
      gap: 8px;
    }

    .analyzing-dots span {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--c-teal);
      animation: analyzing-dot-bounce 1.2s ease-in-out infinite;
    }

    .analyzing-dots span:nth-child(1) { animation-delay: 0s; }
    .analyzing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .analyzing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes analyzing-dot-bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
      40%           { transform: translateY(-12px); opacity: 1; }
    }

    .skeleton-loader {
      width: 260px;
      height: 160px;
      border-radius: 24px;
      background: #f3f4f6;
      box-shadow: 0 18px 36px rgba(15,23,42,0.32);
      padding: 20px 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden;
      transform: rotateX(16deg);
      animation: skeleton-breathe 3s ease-in-out infinite;
    }

    @keyframes skeleton-breathe {
      0%, 100% { transform: rotateX(16deg) translateY(0); }
      50%      { transform: rotateX(18deg) translateY(-4px); }
    }

    .skeleton-row {
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, #e5e7eb, #f9fafb, #e5e7eb);
      background-size: 200% 100%;
      animation: skeleton-move 1s linear infinite;
    }
    .skeleton-row:nth-child(1) { width: 72%; }
    .skeleton-row:nth-child(2) { width: 54%; }
    .skeleton-row:nth-child(3) { width: 86%; }
    .skeleton-row:nth-child(4) { width: 60%; }

    @keyframes skeleton-move {
      0%   { background-position-x: 0%; }
      100% { background-position-x: -200%; }
    }

    .result-badge {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: conic-gradient(from 220deg,
                                  var(--c-orange),
                                  var(--c-pink),
                                  var(--c-teal),
                                  var(--c-orange));
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 22px 44px rgba(15,23,42,0.45);
      color: #fff;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      transform: translateY(0);
      animation: badge-celebrate 2.5s ease-in-out infinite;
      position: relative;
    }

    .result-badge::before {
      content: "";
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      background: inherit;
      filter: blur(20px);
      opacity: 0.4;
      animation: badge-glow-pulse 2s ease-in-out infinite;
    }

    @keyframes badge-celebrate {
      0%, 100% { transform: translateY(0) scale(1) rotate(0deg); }
      25%      { transform: translateY(-8px) scale(1.08) rotate(-5deg); }
      75%      { transform: translateY(-8px) scale(1.08) rotate(5deg); }
    }

    @keyframes badge-glow-pulse {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50%      { opacity: 0.7; transform: scale(1.1); }
    }

    /* Error/Timeout visual */
    .error-visual {
      width: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      text-align: center;
    }

    .error-card-flip {
      width: 180px;
      height: 110px;
      position: relative;
      animation: card-flip-loop 4s ease-in-out infinite;
    }

    @keyframes card-flip-loop {
      0%, 100% { transform: rotateY(0deg) translateY(0); }
      25%      { transform: rotateY(90deg) translateY(-10px); }
      50%      { transform: rotateY(180deg) translateY(0); }
      75%      { transform: rotateY(270deg) translateY(-10px); }
    }

    .error-card-side {
      position: absolute;
      inset: 0;
      border-radius: 16px;
      background: linear-gradient(135deg, #ef4444, #f97316);
      box-shadow: 0 12px 28px rgba(239,68,68,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 0.1em;
    }

    .error-message {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .error-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--c-dark);
      animation: error-text-pulse 2s ease-in-out infinite;
    }

    .error-subtitle {
      font-size: 0.85rem;
      color: var(--c-muted);
      line-height: 1.4;
    }

    @keyframes error-text-pulse {
      0%, 100% { opacity: 1; }
      50%      { opacity: 0.7; }
    }

    .scene-fade-out {
      opacity: 0;
      transform: translateY(12px) scale(0.96) rotateX(5deg);
      transition:
        opacity 260ms var(--easing-soft),
        transform 260ms var(--easing-soft);
    }

    /* ===== THANK YOU POPUP ===== */

    .thank-you-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center,
                                  rgba(255,255,255,0.95) 0%,
                                  rgba(255,247,240,0.98) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition:
        opacity 500ms var(--easing-spring),
        backdrop-filter 500ms ease;
    }

    .thank-you-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .thank-you-card {
      background: radial-gradient(circle at top,
                                  #ffffff 0%,
                                  #fff7f0 100%);
      border-radius: 48px;
      padding: 60px 70px;
      box-shadow: 0 40px 100px rgba(15,23,42,0.25);
      text-align: center;
      transform: scale(0.8) translateY(30px);
      opacity: 0;
      transition:
        transform 600ms var(--easing-bounce),
        opacity 600ms ease;
      position: relative;
      overflow: hidden;
    }

    .thank-you-overlay.active .thank-you-card {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    .thank-you-card::before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      padding: 3px;
      background: linear-gradient(135deg,
                                  var(--c-orange),
                                  var(--c-pink),
                                  var(--c-teal),
                                  var(--c-gold));
      -webkit-mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.6;
      animation: thank-you-border 3s linear infinite;
    }

    @keyframes thank-you-border {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .thank-you-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 24px;
      background: conic-gradient(from 0deg,
                                  var(--c-orange),
                                  var(--c-pink),
                                  var(--c-teal),
                                  var(--c-gold),
                                  var(--c-orange));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      animation: thank-you-icon-spin 3s linear infinite;
      box-shadow: 0 20px 40px rgba(255,138,0,0.3);
    }

    @keyframes thank-you-icon-spin {
      0%   { transform: rotate(0deg) scale(1); }
      50%  { transform: rotate(180deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .thank-you-icon::before {
      content: "‚ú®";
      background: white;
      width: 85%;
      height: 85%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: thank-you-icon-pulse 2s ease-in-out infinite;
    }

    @keyframes thank-you-icon-pulse {
      0%, 100% { transform: scale(1); }
      50%      { transform: scale(1.05); }
    }

    .thank-you-title {
      font-size: 2.2rem;
      font-weight: 800;
      background: linear-gradient(135deg,
                                  var(--c-orange),
                                  var(--c-pink),
                                  var(--c-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 16px;
      animation: thank-you-text-shimmer 3s ease-in-out infinite;
    }

    @keyframes thank-you-text-shimmer {
      0%, 100% { opacity: 1; }
      50%      { opacity: 0.85; }
    }

    .thank-you-message {
      font-size: 1.1rem;
      color: var(--c-muted);
      line-height: 1.6;
      max-width: 400px;
      margin: 0 auto 8px;
    }

    .thank-you-subtitle {
      font-size: 0.95rem;
      color: var(--c-dark);
      font-weight: 600;
      margin-top: 12px;
    }

    .thank-you-sparkles {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .sparkle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: var(--c-gold);
      border-radius: 50%;
      opacity: 0;
      animation: sparkle-float 3s ease-in-out infinite;
    }

    .sparkle:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
    .sparkle:nth-child(2) { left: 85%; top: 15%; animation-delay: 0.5s; }
    .sparkle:nth-child(3) { left: 15%; top: 75%; animation-delay: 1s; }
    .sparkle:nth-child(4) { left: 80%; top: 70%; animation-delay: 1.5s; }
    .sparkle:nth-child(5) { left: 50%; top: 10%; animation-delay: 0.8s; }
    .sparkle:nth-child(6) { left: 50%; top: 85%; animation-delay: 1.8s; }

    @keyframes sparkle-float {
      0%, 100% { opacity: 0; transform: translateY(0) scale(0); }
      50%      { opacity: 1; transform: translateY(-20px) scale(1.5); }
    }
  </style>
</head>
<body>
  <!-- Wall / Result iframe -->
  <iframe id="mainFrame"></iframe>

  <!-- Free-floating butterflies (background) -->
  <div class="butterfly-field" id="butterfly-field">
    <img src="/static/butterfly.png" class="butterfly-free" data-index="1" alt="" />
    <img src="/static/butterfly.png" class="butterfly-free" data-index="2" alt="" />
    <img src="/static/butterfly.png" class="butterfly-free" data-index="3" alt="" />
  </div>

  <!-- Process box overlay -->
  <div class="process-shell">
    <div class="process-card" id="process-card">
      <div class="process-border border-muted" id="process-border"></div>
      <div class="process-inner">

        <!-- Internal VFX -->
        <div class="process-vfx">
          <div class="process-vfx-gradient"></div>
          <div class="process-vfx-lines"></div>
          <div class="process-vfx-orbit">
            <div class="process-vfx-orbit-ring"></div>
          </div>
        </div>

        <!-- State visuals -->
        <div class="scene-strip" id="scene-strip"></div>

        <!-- Main butterfly -->
        <div class="butterfly-container">
          <img src="/static/butterfly.png"
               alt="Mahdiyyah butterfly"
               class="butterfly-img" />
        </div>

        <!-- Status -->
        <div class="status-chip">
          <span class="status-dot"></span>
          <span id="status-text">Idle ‚Ä¢ Wall</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Thank You Overlay -->
  <div class="thank-you-overlay" id="thank-you-overlay">
    <div class="thank-you-card">
      <div class="thank-you-sparkles">
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
      </div>
      <div class="thank-you-icon"></div>
      <h1 class="thank-you-title">Excellent!</h1>
      <p class="thank-you-message">
        Your results have been reviewed successfully. Keep up the great work!
      </p>
      <p class="thank-you-subtitle">May Allah bless your efforts ü§≤</p>
    </div>
  </div>

  <!-- Audio -->
  <audio id="snd-insert" src="/static/insert.mp3" preload="auto"></audio>
  <audio id="snd-check" src="/static/check.mp3" preload="auto"></audio>
  <audio id="snd-analyze" src="/static/analyze.mp3" preload="auto"></audio>
  <audio id="snd-success" src="/static/success.mp3" preload="auto"></audio>
  <audio id="snd-error" src="/static/error.mp3" preload="auto"></audio>

<script>
  // ===== CONFIG =====
  const URL_LEADERBOARD = "https://shefest-a.festie.app/wall";
  const URL_RESULT_BASE = "https://shefest-c.festie.app/results/candidates/";

  const VIEW_TIMEOUT_MS = 7 * 60 * 1000;
  const NO_SCAN_TIMEOUT_MS = 20 * 60 * 1000;
  const THANK_YOU_DURATION_MS = 4000;

  // Network retry configuration
  const RETRY_CONFIG = {
    maxRetries: 3,
    baseDelay: 1000,        // 1 second
    maxDelay: 10000,        // 10 seconds
    backoffMultiplier: 2,   // Exponential backoff
    timeout: 5000           // 5 second request timeout
  };

  const processShell  = document.querySelector(".process-shell");
  const processCard   = document.getElementById("process-card");
  const processBorder = document.getElementById("process-border");
  const sceneStrip    = document.getElementById("scene-strip");
  const statusText    = document.getElementById("status-text");
  const frame         = document.getElementById("mainFrame");
  const thankYouOverlay = document.getElementById("thank-you-overlay");

  const sndInsert  = document.getElementById("snd-insert");
  const sndCheck   = document.getElementById("snd-check");
  const sndAnalyze = document.getElementById("snd-analyze");
  const sndSuccess = document.getElementById("snd-success");
  const sndError   = document.getElementById("snd-error");

  const STATES = {
    IDLE: "IDLE",
    CARD_INSERTED: "CARD_INSERTED",
    CHECKING_BARCODE: "CHECKING_BARCODE",
    ANALYZING_BARCODE: "ANALYZING_BARCODE",
    BUILDING_VIEW: "BUILDING_VIEW",
    RESULT_READY: "RESULT_READY",
    TIMEOUT_ERROR: "TIMEOUT_ERROR"
  };

  let currentState = STATES.IDLE;
  let isCardInserted = false;
  let wasShowingResult = false;
  let barcodeBuffer = "";
  let barcodeTimeout = null;
  let stateTimeout = null;
  let noScanTimer = null;
  let viewTimer = null;

  // Network state tracking
  let networkHealthy = true;
  let consecutiveFailures = 0;
  const MAX_CONSECUTIVE_FAILURES = 5;

  // ===== NETWORK RETRY UTILITY =====

  /**
   * Fetch with automatic retry and exponential backoff
   * @param {string} url - The URL to fetch
   * @param {object} options - Fetch options
   * @param {number} retryCount - Current retry attempt (internal)
   * @returns {Promise<Response>}
   */
  async function fetchWithRetry(url, options = {}, retryCount = 0) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), RETRY_CONFIG.timeout);

    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      // Reset failure counter on success
      if (response.ok) {
        if (consecutiveFailures > 0) {
          console.log(`‚úÖ Network recovered after ${consecutiveFailures} failures`);
          consecutiveFailures = 0;
          updateNetworkStatus(true);
        }
      }

      return response;

    } catch (error) {
      clearTimeout(timeoutId);

      // Check if we should retry
      const shouldRetry = retryCount < RETRY_CONFIG.maxRetries;
      const isNetworkError = error.name === 'TypeError' || error.name === 'AbortError';

      if (shouldRetry && isNetworkError) {
        // Calculate exponential backoff delay
        const delay = Math.min(
          RETRY_CONFIG.baseDelay * Math.pow(RETRY_CONFIG.backoffMultiplier, retryCount),
          RETRY_CONFIG.maxDelay
        );

        console.warn(
          `‚ö†Ô∏è Network request failed (attempt ${retryCount + 1}/${RETRY_CONFIG.maxRetries + 1}). ` +
          `Retrying in ${delay}ms...`
        );

        consecutiveFailures++;
        updateNetworkStatus(false);

        // Wait before retrying
        await new Promise(resolve => setTimeout(resolve, delay));

        // Retry the request
        return fetchWithRetry(url, options, retryCount + 1);
      }

      // Max retries reached or non-network error
      if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
        console.error(`‚ùå Network appears to be offline (${consecutiveFailures} consecutive failures)`);
        updateNetworkStatus(false);
      }

      throw error;
    }
  }

  /**
   * Update network status indicator
   * @param {boolean} healthy - Whether network is healthy
   */
  function updateNetworkStatus(healthy) {
    if (networkHealthy !== healthy) {
      networkHealthy = healthy;
      
      if (!healthy) {
        console.warn('üî¥ Network connection unstable');
      } else {
        console.log('üü¢ Network connection restored');
      }
    }
  }

  // ===== SHELL VISIBILITY =====

  function showShell() {
    processShell.classList.add("shell-active");
  }

  function hideShell() {
    processShell.classList.remove("shell-active");
  }

  // ===== THANK YOU POPUP =====

  function showThankYou() {
    playSound(sndSuccess, false);
    thankYouOverlay.classList.add("active");
    setTimeout(() => {
      thankYouOverlay.classList.remove("active");
    }, THANK_YOU_DURATION_MS);
  }

  // ===== HELPERS =====

  function setStatus(text) {
    statusText.textContent = text;
  }

  function clearScene() {
    sceneStrip.innerHTML = "";
  }

  function playSound(el, loop = false) {
    if (!el) return;
    el.loop = loop;
    el.currentTime = 0;
    el.play().catch(() => {});
  }

  function stopSound(el) {
    if (!el) return;
    el.pause();
    el.currentTime = 0;
    el.loop = false;
  }

  function clearTimers() {
    clearTimeout(stateTimeout);
    clearTimeout(noScanTimer);
    clearTimeout(viewTimer);
    stateTimeout = noScanTimer = viewTimer = null;
  }

  function setBorderState(cls) {
    processBorder.className = "process-border " + cls;
  }

  function setCardStateClass(s) {
    processCard.classList.remove(
      "state-inserted",
      "state-checking",
      "state-analyzing",
      "state-building",
      "state-result",
      "state-error"
    );
    if (s === STATES.CARD_INSERTED)      processCard.classList.add("state-inserted");
    if (s === STATES.CHECKING_BARCODE)   processCard.classList.add("state-checking");
    if (s === STATES.ANALYZING_BARCODE)  processCard.classList.add("state-analyzing");
    if (s === STATES.BUILDING_VIEW)      processCard.classList.add("state-building");
    if (s === STATES.RESULT_READY)       processCard.classList.add("state-result");
    if (s === STATES.TIMEOUT_ERROR)      processCard.classList.add("state-error");
  }

  // ===== SCENE BUILDERS =====

  function buildCardScene() {
    clearScene();
    const card = document.createElement("div");
    card.className = "card-visual";
    card.textContent = "MAHDIYYAH ID";
    sceneStrip.appendChild(card);
  }

  function buildCheckingScene() {
    clearScene();
    const wrap = document.createElement("div");
    wrap.className = "checking-visual";

    const scanner = document.createElement("div");
    scanner.className = "checking-scanner";

    const grid = document.createElement("div");
    grid.className = "checking-grid";
    for (let i = 0; i < 8; i++) {
      const bar = document.createElement("span");
      grid.appendChild(bar);
    }

    const beam = document.createElement("div");
    beam.className = "checking-beam";

    scanner.appendChild(grid);
    scanner.appendChild(beam);

    const label = document.createElement("div");
    label.className = "checking-label";
    label.textContent = "Reading Barcode";

    wrap.appendChild(scanner);
    wrap.appendChild(label);
    sceneStrip.appendChild(wrap);
  }

  function buildAnalyzingScene() {
    clearScene();
    const wrap = document.createElement("div");
    wrap.className = "analyzing-visual";

    const circle = document.createElement("div");
    circle.className = "analyzing-circle";

    const dots = document.createElement("div");
    dots.className = "analyzing-dots";
    for (let i = 0; i < 3; i++) {
      const dot = document.createElement("span");
      dots.appendChild(dot);
    }

    wrap.appendChild(circle);
    wrap.appendChild(dots);
    sceneStrip.appendChild(wrap);
  }

  function buildSkeletonScene() {
    clearScene();
    const loader = document.createElement("div");
    loader.className = "skeleton-loader";
    for (let i = 0; i < 4; i++) {
      const row = document.createElement("div");
      row.className = "skeleton-row";
      loader.appendChild(row);
    }
    sceneStrip.appendChild(loader);
  }

  function buildResultScene() {
    clearScene();
    const badge = document.createElement("div");
    badge.className = "result-badge";
    badge.textContent = "RANK";
    sceneStrip.appendChild(badge);
  }

  function buildErrorScene() {
    clearScene();
    const wrap = document.createElement("div");
    wrap.className = "error-visual";

    const cardFlip = document.createElement("div");
    cardFlip.className = "error-card-flip";

    const cardSide = document.createElement("div");
    cardSide.className = "error-card-side";
    cardSide.textContent = "FLIP CARD";

    cardFlip.appendChild(cardSide);

    const message = document.createElement("div");
    message.className = "error-message";

    const title = document.createElement("div");
    title.className = "error-title";
    title.textContent = "Please Flip & Reinsert";

    const subtitle = document.createElement("div");
    subtitle.className = "error-subtitle";
    subtitle.innerHTML = "Remove the card, flip it over,<br>and insert with barcode side first";

    message.appendChild(title);
    message.appendChild(subtitle);

    wrap.appendChild(cardFlip);
    wrap.appendChild(message);
    sceneStrip.appendChild(wrap);
  }

  // ===== STATE MACHINE =====

  function goToState(state, data = {}) {
    currentState = state;

    processCard.classList.remove("visible");
    processCard.classList.add("scene-fade-out");

    setTimeout(() => {
      clearScene();
      setCardStateClass(state);

      switch (state) {
        case STATES.IDLE:
          hideShell();
          setBorderState("border-muted");
          buildCardScene();
          setStatus("Idle ‚Ä¢ Wall");
          frame.src = URL_LEADERBOARD;
          break;

        case STATES.CARD_INSERTED:
          showShell();
          setBorderState("border-active");
          buildCardScene();
          setStatus("Card Inserted");
          playSound(sndInsert, false);
          break;

        case STATES.CHECKING_BARCODE:
          showShell();
          setBorderState("border-checking");
          buildCheckingScene();
          setStatus("Checking Barcode");
          playSound(sndCheck, false);
          break;

        case STATES.ANALYZING_BARCODE:
          showShell();
          setBorderState("border-analyzing");
          buildAnalyzingScene();
          setStatus("Analyzing Data");
          playSound(sndAnalyze, false);
          break;

        case STATES.BUILDING_VIEW:
          showShell();
          setBorderState("border-muted");
          buildSkeletonScene();
          setStatus("Building View");
          break;

        case STATES.RESULT_READY:
          showShell();
          setBorderState("border-success");
          buildResultScene();
          setStatus("Results Ready");

          const barcode = data.barcode;
          if (barcode) {
            const onLoad = () => {
              frame.removeEventListener("load", onLoad);
              hideShell();
            };
            frame.addEventListener("load", onLoad);
            frame.src = URL_RESULT_BASE + encodeURIComponent(barcode);
          }
          break;

        case STATES.TIMEOUT_ERROR:
          showShell();
          setBorderState("border-error");
          buildErrorScene();
          setStatus("Timeout ‚Ä¢ Reinsert");
          playSound(sndError, false);
          break;
      }

      processCard.classList.remove("scene-fade-out");
      processCard.classList.add("visible");
    }, 260);
  }

  // ===== CARD SENSOR POLLING (WITH RETRY) =====

  async function checkCardStatus() {
    try {
      const res = await fetchWithRetry("/api/status", { cache: "no-store" });
      
      if (!res.ok) {
        console.warn(`‚ö†Ô∏è Status check returned ${res.status}`);
        return;
      }

      const data = await res.json();

      if (data.card_inserted && !isCardInserted) {
        isCardInserted = true;
        clearTimers();
        goToState(STATES.CARD_INSERTED);
        
        noScanTimer = setTimeout(() => {
          if (currentState === STATES.CARD_INSERTED ||
              currentState === STATES.CHECKING_BARCODE ||
              currentState === STATES.ANALYZING_BARCODE) {
            goToState(STATES.TIMEOUT_ERROR);
          }
        }, NO_SCAN_TIMEOUT_MS);

      } else if (!data.card_inserted && isCardInserted) {
        isCardInserted = false;
        clearTimers();

        if (wasShowingResult && currentState !== STATES.TIMEOUT_ERROR) {
          wasShowingResult = false;
          showThankYou();
          setTimeout(() => {
            goToState(STATES.IDLE);
          }, 500);
        } else {
          goToState(STATES.IDLE);
        }
      }
    } catch (err) {
      console.error("‚ùå Failed to check card status:", err.message);
      // Don't change state on network errors - maintain current state
    }
  }

  setInterval(checkCardStatus, 500);

  // ===== BARCODE HANDLING (WITH RETRY) =====

  function canAcceptBarcode() {
    return isCardInserted &&
      (currentState === STATES.CARD_INSERTED ||
       currentState === STATES.CHECKING_BARCODE ||
       currentState === STATES.ANALYZING_BARCODE);
  }

  document.addEventListener("keydown", (e) => {
    if (!canAcceptBarcode()) return;

    if (e.key === "Enter") {
      const code = barcodeBuffer.trim();
      if (code.length > 2) {
        const captured = code;
        barcodeBuffer = "";
        handleBarcode(captured);
      } else {
        barcodeBuffer = "";
      }
    } else if (e.key.length === 1) {
      barcodeBuffer += e.key;
    }

    clearTimeout(barcodeTimeout);
    barcodeTimeout = setTimeout(() => { barcodeBuffer = ""; }, 150);
  });

  async function handleBarcode(code) {
    clearTimers();

    goToState(STATES.CHECKING_BARCODE);
    await new Promise(resolve => setTimeout(resolve, 1800));

    goToState(STATES.ANALYZING_BARCODE);

    let ok = true;
    try {
      const response = await fetchWithRetry("/api/scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ barcode: code }),
        cache: "no-store"
      });

      if (!response.ok) {
        console.error(`‚ùå Scan API returned ${response.status}`);
        ok = false;
      }
    } catch (err) {
      console.error("‚ùå Failed to submit scan:", err.message);
      ok = false;
    }

    await new Promise(resolve => setTimeout(resolve, 2000));

    if (!ok) {
      // Network error during scan - return to idle
      goToState(STATES.IDLE);
      return;
    }

    goToState(STATES.BUILDING_VIEW);
    await new Promise(resolve => setTimeout(resolve, 2500));

    wasShowingResult = true;
    goToState(STATES.RESULT_READY, { barcode: code });

    viewTimer = setTimeout(() => {
      if (currentState === STATES.RESULT_READY && isCardInserted) {
        goToState(STATES.IDLE);
        wasShowingResult = false;
      }
    }, VIEW_TIMEOUT_MS);
  }

  // ===== INITIALIZE =====
  frame.src = URL_LEADERBOARD;
  goToState(STATES.IDLE);

  // ===== NETWORK HEALTH MONITORING =====
  
  // Periodic health check (every 10 seconds)
  setInterval(async () => {
    try {
      await fetchWithRetry("/api/health", { cache: "no-store" });
    } catch (err) {
      console.warn("‚ö†Ô∏è Health check failed:", err.message);
    }
  }, 10000);

  // Log network statistics on page unload
  window.addEventListener('beforeunload', () => {
    console.log(`üìä Session Stats: ${consecutiveFailures} network failures`);
  });
</script>

  <!-- FREE-FLOATING BUTTERFLIES SCRIPT (OLD SIMPLE VERSION) -->
  <script>
    const butterflies = Array.from(document.querySelectorAll(".butterfly-free"));

    function wanderButterfly(bf) {
      const duration = 50 + Math.random() * 20;
      const targetX = -10 + Math.random() * 120;
      const targetY = -10 + Math.random() * 120;
      const rot = Math.random() * 60 - 30;
      const scale = 3 + Math.random() * 0.7;

      bf.style.transition = `transform ${duration}s cubic-bezier(0.23,1,0.32,1)`;
      bf.style.transform = `translate(${targetX}vw, ${targetY}vh) rotate(${rot}deg) scale(${scale})`;
    }

    function startWandering() {
      butterflies.forEach((bf, i) => {
        setTimeout(() => {
          wanderButterfly(bf);
          setInterval(() => {
            wanderButterfly(bf);
          }, 9000 + Math.random() * 4000);
        }, 600 + i * 900);
      });
    }

    setTimeout(startWandering, 800);
  </script>
</body>
</html>
